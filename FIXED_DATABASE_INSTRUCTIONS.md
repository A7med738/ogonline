# إصلاح مشكلة ON CONFLICT - نظام احجزلي

## ❌ **المشكلة:**
```
ERROR: 42P10: there is no unique or exclusion constraint matching the ON CONFLICT specification
```

## 🔍 **السبب:**
- `ON CONFLICT (id) DO NOTHING` يحاول استخدام constraint غير موجود
- الجداول لا تحتوي على constraint فريد على `id`
- البيانات التجريبية تحاول إدراج نفس البيانات مرتين

## ✅ **الحل:**

### **الخطوة 1: استخدام الملف المحدث**

**استخدم ملف `CREATE_BOOK_SERVICE_TABLES_FIXED.sql` بدلاً من الملف السابق**

### **الخطوة 2: تشغيل SQL في Supabase Dashboard**

1. **افتح Supabase Dashboard:**
   - اذهب إلى: https://supabase.com/dashboard
   - اختر مشروعك

2. **افتح SQL Editor:**
   - اضغط على "SQL Editor" في القائمة الجانبية
   - اضغط على "New query"

3. **انسخ والصق الكود:**
   - افتح ملف `CREATE_BOOK_SERVICE_TABLES_FIXED.sql`
   - انسخ جميع محتويات الملف
   - الصق في SQL Editor

4. **شغل الكود:**
   - اضغط على "Run" أو `Ctrl+Enter`
   - انتظر حتى يكتمل التنفيذ

### **الخطوة 3: التحقق من الجداول**

1. **اذهب إلى Table Editor:**
   - اضغط على "Table Editor" في القائمة الجانبية

2. **تحقق من الجداول الجديدة:**
   - `book_service_health_centers`
   - `book_service_clinics`
   - `book_service_appointments`
   - `book_service_clinic_queues`
   - `book_service_queue_status`

## 🔧 **ما تم إصلاحه:**

### **1. إزالة ON CONFLICT:**
- تم حذف `ON CONFLICT (id) DO NOTHING`
- تم استبداله بـ `DELETE` أولاً ثم `INSERT`

### **2. ترتيب الإدراج:**
- حذف البيانات الموجودة أولاً
- إدراج البيانات الجديدة بعد ذلك

### **3. البيانات التجريبية:**
- مركز صحي واحد: "مركز الصحة الشامل"
- 11 عيادة مختلفة
- بيانات الطابور لكل عيادة

## 📋 **البيانات التجريبية:**

### **المركز الصحي:**
- **الاسم:** مركز الصحة الشامل
- **العنوان:** شارع الملك فهد، حي النخيل، الرياض
- **الهاتف:** +966501234567
- **التقييم:** 4.8/5
- **الخدمات:** طب عام، أطفال، نساء وولادة، أسنان، عيون، أنف وأذن وحنجرة، جلدية، عظام، قلب، أعصاب

### **العيادات:**
1. **عيادة الطب العام** - د. أحمد محمد (150 ريال)
2. **عيادة الأطفال** - د. فاطمة علي (200 ريال)
3. **عيادة النساء والولادة** - د. مريم حسن (300 ريال)
4. **عيادة الأسنان** - د. خالد عبدالله (250 ريال)
5. **عيادة العيون** - د. نورا سعد (180 ريال)
6. **عيادة الأنف والأذن** - د. عمر يوسف (220 ريال)
7. **عيادة الجلدية** - د. لينا محمود (200 ريال)
8. **عيادة العظام** - د. سعد الدين (280 ريال)
9. **عيادة القلب** - د. هدى أحمد (350 ريال)
10. **عيادة الأعصاب** - د. يوسف محمد (320 ريال)
11. **عيادة الباطنة** - د. ريم عبدالرحمن (240 ريال)

## 🎯 **النتيجة المتوقعة:**

بعد تشغيل SQL:
- ✅ **الحجز سيعمل بدون أخطاء**
- ✅ **نظام الطابور سيعمل تلقائياً**
- ✅ **المريض سيحصل على رقم طابور**
- ✅ **جميع الصفحات ستعمل بشكل صحيح**
- ✅ **البيانات التجريبية ستكون جاهزة**

## ⚠️ **ملاحظات مهمة:**

1. **استخدم الملف المحدث:** `CREATE_BOOK_SERVICE_TABLES_FIXED.sql`
2. **لا تحذف الجداول الموجودة** - هذا النظام منفصل تماماً
3. **أسماء الجداول تبدأ بـ `book_service_`** - لتجنب التداخل
4. **البيانات التجريبية جاهزة** - يمكنك البدء بالاختبار فوراً

---
**تاريخ الإصلاح**: 2025-01-25  
**الحالة**: تم الإصلاح بنجاح ✅
