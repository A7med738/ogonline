# الحل الشامل والدقيق لنظام احجزلي

## ❌ **المشكلة:**
```
ERROR: 42703: column "queue_number" does not exist
```

## 🎯 **الحل الشامل:**
**حل شامل ودقيق يبدأ من الصفر ويضمن إنشاء جميع الجداول والأعمدة**

## ✅ **الخطوات:**

### **الخطوة 1: استخدام الحل الشامل**

**استخدم ملف `COMPLETE_SOLUTION.sql` - هذا هو الحل الشامل والدقيق**

### **الخطوة 2: تشغيل SQL في Supabase Dashboard**

1. **افتح Supabase Dashboard:**
   - اذهب إلى: https://supabase.com/dashboard
   - اختر مشروعك

2. **افتح SQL Editor:**
   - اضغط على "SQL Editor" في القائمة الجانبية
   - اضغط على "New query"

3. **انسخ والصق الكود:**
   - افتح ملف `COMPLETE_SOLUTION.sql`
   - انسخ جميع محتويات الملف
   - الصق في SQL Editor

4. **شغل الكود:**
   - اضغط على "Run" أو `Ctrl+Enter`
   - انتظر حتى يكتمل التنفيذ

### **الخطوة 3: التحقق من الجداول**

1. **اذهب إلى Table Editor:**
   - اضغط على "Table Editor" في القائمة الجانبية

2. **تحقق من الجداول الجديدة:**
   - `book_service_health_centers`
   - `book_service_clinics`
   - `book_service_appointments`

## 🔧 **ما يميز هذا الحل:**

### **1. الحذف الكامل أولاً:**
- **حذف جميع الجداول الموجودة** باستخدام `DROP TABLE IF EXISTS ... CASCADE`
- **ضمان البدء من الصفر** بدون أي تداخل

### **2. الإنشاء الكامل:**
- **إنشاء الجداول من الصفر** باستخدام `CREATE TABLE`
- **ضمان وجود جميع الأعمدة** بما في ذلك `queue_number` و `queue_position`

### **3. البيانات التجريبية:**
- **مركز صحي واحد** مع جميع التفاصيل
- **11 عيادة مختلفة** مع أطباء متخصصين
- **بيانات كاملة وجاهزة للاستخدام**

### **4. الأمان والسياسات:**
- **تفعيل RLS** لجميع الجداول
- **سياسات أمان شاملة** للمستخدمين والمديرين
- **حذف السياسات القديمة** قبل إنشاء الجديدة

### **5. الفهارس والأداء:**
- **فهارس شاملة** لتحسين الأداء
- **فهارس على الأعمدة المهمة** مثل `clinic_id`, `user_id`, `queue_number`

### **6. التحقق النهائي:**
- **استعلام للتحقق** من إنشاء الجداول والأعمدة
- **عرض هيكل الجداول** للتأكد من صحة الإنشاء

## 📋 **البيانات التجريبية:**

### **المركز الصحي:**
- **الاسم:** مركز الصحة الشامل
- **العنوان:** شارع الملك فهد، حي النخيل، الرياض
- **الهاتف:** +966501234567
- **التقييم:** 4.8/5
- **الخدمات:** طب عام، أطفال، نساء وولادة، أسنان، عيون، أنف وأذن وحنجرة، جلدية، عظام، قلب، أعصاب

### **العيادات:**
1. **عيادة الطب العام** - د. أحمد محمد (150 ريال)
2. **عيادة الأطفال** - د. فاطمة علي (200 ريال)
3. **عيادة النساء والولادة** - د. مريم حسن (300 ريال)
4. **عيادة الأسنان** - د. خالد عبدالله (250 ريال)
5. **عيادة العيون** - د. نورا سعد (180 ريال)
6. **عيادة الأنف والأذن** - د. عمر يوسف (220 ريال)
7. **عيادة الجلدية** - د. لينا محمود (200 ريال)
8. **عيادة العظام** - د. سعد الدين (280 ريال)
9. **عيادة القلب** - د. هدى أحمد (350 ريال)
10. **عيادة الأعصاب** - د. يوسف محمد (320 ريال)
11. **عيادة الباطنة** - د. ريم عبدالرحمن (240 ريال)

## 🎯 **النتيجة المتوقعة:**

بعد تشغيل SQL:
- ✅ **الجداول ستُنشأ بدون أخطاء**
- ✅ **جميع الأعمدة ستكون موجودة** بما في ذلك `queue_number`
- ✅ **البيانات التجريبية ستكون جاهزة**
- ✅ **النظام سيعمل بشكل كامل**
- ✅ **سيتم عرض هيكل الجداول** للتأكد من صحة الإنشاء

## ⚠️ **ملاحظات مهمة:**

1. **استخدم الحل الشامل:** `COMPLETE_SOLUTION.sql`
2. **هذا الحل يبدأ من الصفر** ويحذف كل شيء موجود
3. **جميع الأعمدة ستكون موجودة** بما في ذلك `queue_number`
4. **البيانات التجريبية جاهزة** للاستخدام الفوري
5. **النظام شامل ومتكامل**

## 🚀 **الخطوات التالية:**

بعد تشغيل SQL بنجاح:
1. **تحقق من ظهور الجداول** في Table Editor
2. **ارجع للتطبيق**
3. **جرب حجز موعد جديد**
4. **تحقق من أن النظام يعمل بدون أخطاء**
5. **تأكد من ظهور البيانات التجريبية**

## 🔧 **إضافة الطابور التلقائي لاحقاً:**

إذا عمل النظام بشكل أساسي، يمكن إضافة trigger لاحقاً لحساب الطابور تلقائياً:

```sql
-- إضافة trigger لاحقاً
CREATE OR REPLACE FUNCTION update_queue_on_appointment()
RETURNS TRIGGER AS $$
BEGIN
  -- حساب رقم الطابور التالي
  SELECT COALESCE(MAX(queue_number), 0) + 1 
  INTO NEW.queue_number
  FROM book_service_appointments 
  WHERE clinic_id = NEW.clinic_id 
    AND appointment_date = NEW.appointment_date
    AND status IN ('pending', 'confirmed');
  
  -- حساب موضع المريض
  NEW.queue_position := NEW.queue_number;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_queue
  BEFORE INSERT ON book_service_appointments
  FOR EACH ROW
  EXECUTE FUNCTION update_queue_on_appointment();
```

## 📊 **التحقق من النجاح:**

بعد تشغيل SQL، يجب أن ترى في النتيجة:
- **جدول `book_service_health_centers`** مع 15 عمود
- **جدول `book_service_clinics`** مع 10 أعمدة
- **جدول `book_service_appointments`** مع 15 عمود بما في ذلك `queue_number`

---
**تاريخ الإصلاح**: 2025-01-25  
**الحالة**: الحل الشامل والدقيق جاهز ✅
